function coef = computeCorrelationCoef(datesPeriods, salesPeriods, maxTempPeriods, slopeAvg)  % Each sales data point transformed based on the slope and the average of  % its period  filteredTemps = [];  filteredDates = [];  transformedSales = [];  for periodIndex = 1:size(datesPeriods, 1)        % Get data for current period    salesPeriod = salesPeriods(periodIndex, :);    tempPeriod = maxTempPeriods(periodIndex, :);    validIndexes = intersect(find(salesPeriod > 0), find(tempPeriod >= 10));       % Nothing to do if none of the data is valid    if length(validIndexes) == 0      continue;    end        % Filter invalid data    datesPeriod = datesPeriods(periodIndex, :)(validIndexes);    salesPeriod = salesPeriod(validIndexes);    tempPeriod = tempPeriod(validIndexes);        deltaSalesPlusMean = salesPeriod - slopeAvg .* (datesPeriod - mean(datesPeriod));    filteredDates = [filteredDates datesPeriod];    filteredTemps = [filteredTemps tempPeriod];    transformedSales = [transformedSales deltaSalesPlusMean];  end  % Analyse the last year seperately  firstDayOfYr3 = 732;  indexesYr3 = find(filteredDates >= firstDayOfYr3);  indexesYr1And2 = find(filteredDates < firstDayOfYr3);  sales1 = transformedSales(indexesYr3);  sales2 = transformedSales(indexesYr1And2);  coef1 = corrcoef(filteredTemps(indexesYr3), sales1)(1,2);  coef2 = corrcoef(filteredTemps(indexesYr1And2), sales2)(1,2);  coef = mean([coef1 coef2]);
endfunction
