function coef = computeCorrelationCoef(datesPeriods, salesPeriods, maxTempPeriods, slopeAvg)  % Each sales data point transformed based on the slope and the average of  % its period  filteredTemps = [];  filteredDates = [];  transformedSales = [];  for periodIndex = 1:size(datesPeriods, 1)        % Get data for current period    salesPeriod = salesPeriods(periodIndex, :);    tempPeriod = maxTempPeriods(periodIndex, :);    validIndexes = intersect(find(salesPeriod > 0), find(tempPeriod >= 10));       % Nothing to do if none of the data is valid    if length(validIndexes) == 0      continue;    end        % Filter invalid data    datesPeriod = datesPeriods(periodIndex, :)(validIndexes);    salesPeriod = salesPeriod(validIndexes);    tempPeriod = tempPeriod(validIndexes);        deltaSalesPlusMean = salesPeriod - slopeAvg .* (datesPeriod - mean(datesPeriod));    filteredDates = [filteredDates datesPeriod];    filteredTemps = [filteredTemps tempPeriod];    transformedSales = [transformedSales deltaSalesPlusMean];  end  % Analyse the last year seperately  firstDayOfYr3 = 732;  lastDayYr1 = 365;  % The 1st year data excluding outliers  indexesYr1 = find(filteredDates <= lastDayYr1);  [dates1, sales1, temp1] = removeOutliers(indexesYr1, filteredDates, transformedSales, filteredTemps);      % The 2rd year data excluding outliers  indexesYr2 = intersect(find(filteredDates > lastDayYr1), find(filteredDates < firstDayOfYr3));  [dates2, sales2, temp2] = removeOutliers(indexesYr2, filteredDates, transformedSales, filteredTemps);  % The 3rd year data excluding outliers  indexesYr3 = find(filteredDates >= firstDayOfYr3);  [dates3, sales3, temp3] = removeOutliers(indexesYr3, filteredDates, transformedSales, filteredTemps);       % Normalise the data before putting it back together  normalise = @(data) (data - min(data)) / (max(data) - min(data));  sales1 = normalise(sales1);  sales2 = normalise(sales2);  sales3 = normalise(sales3);     % Compute coefficient  coef = corrcoef([temp1, temp2, temp3], [sales1, sales2, sales3])(1,2);
endfunction
